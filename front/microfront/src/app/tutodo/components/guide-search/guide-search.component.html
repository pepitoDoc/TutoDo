<div class="page">
  @if(searchMode) {
  <div class="align-flex-column mt-4">
    <div class="title">
      <h1>Búsqueda de guías</h1>
    </div>
    <div class="white-card">
      <h1>Filtrar búsqueda de guías</h1>
      <h3>Por favor, rellene el siguiente formulario con la información que desee
        para filtrar la búsqueda de las guías según los criterios
      </h3>
      <form class="example-form" [formGroup]="guideFilter">
        <mat-form-field class="example-full-width" appareance="fill">
          <mat-label>Título</mat-label>
          <input type="text" matInput #inputTitle [maxlength]="100" formControlName="title"
            placeholder="Título de la guía a buscar">
          <mat-hint align="start">{{inputTitle.value.length}}/100</mat-hint>
        </mat-form-field>
        <mat-form-field class="example-full-width" appareance="fill">
          <mat-label>Nombre del usuario creador</mat-label>
          <input type="text" matInput #inputUser [maxlength]="100" formControlName="username"
            placeholder="Nombre del usuario que ha creado la guía">
          <mat-hint align="start">{{inputUser.value.length}}/100</mat-hint>
        </mat-form-field>
        <mat-form-field class="example-chip-list">
          <mat-label>Tipos de la guía</mat-label>
          <mat-chip-grid #chipGrid aria-label="Guide types">
            @for (guideType of chosenTypes; track guideType) {
            <mat-chip-row (removed)="remove(guideType)">
              {{guideType}}
              <button matChipRemove [attr.aria-label]="'remove ' + guideType">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
            }
          </mat-chip-grid>
          <input placeholder="Introduzca los tipos de guía que desea buscar" #guideTypeInput
            formControlName="guideTypes" [matChipInputFor]="chipGrid" [matAutocomplete]="auto"
            [matChipInputSeparatorKeyCodes]="_separatorKeysCodes" />
          <mat-hint align="start">{{chosenTypes.length}}/5 (mínimo 1 tipo de guía)</mat-hint>
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selected($event)">
            @for (guideType of filteredTypes | async; track guideType) {
            <mat-option [value]="guideType" *ngIf="!chosenTypes.includes(guideType | titlecase)">{{guideType |
              titlecase}}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
        <mat-form-field class="example-full-width rating" appareance="fill" name="rating">
          <mat-label>Puntuaciones</mat-label>
          <mat-select formControlName="rating">
            <mat-option [value]="0">Cualquier puntuación</mat-option>
            @for (rating of ratings; track rating) {
            <mat-option [value]="rating.value">{{rating.description}}</mat-option>
            }
          </mat-select>
          <mat-hint align="start">Se buscarán guías con puntuación igual o mayor a la elegida</mat-hint>
        </mat-form-field>
        <div class="align-flex-row">
          <button mat-flat-button class="buttonSpace mx-4" routerLink="/home" routerLinkActive="active"
            color="warn">Cancelar</button>
          <button mat-flat-button class="buttonSpace mx-4" [disabled]="!atLeastOneValue()" color="primary"
            (click)="searchGuide()">Realizar búsqueda</button>
        </div>
      </form>
    </div>
  </div>
  }
  @if(!searchMode) {
  <div class="align-grid">
    @for(guideInfo of findByFilterResponse.guidesFound; track guideInfo) {
    <mat-card class="example-card guide-card">
      <mat-card-header>
        <mat-card-title>{{ guideInfo.guide.title }}</mat-card-title>
        <mat-card-subtitle>Usuario creador: <button mat-button color="primary">{{ guideInfo.username
            }}</button></mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-card-content class="guide-resume">
        <div class="guide-info">
          <p><strong>Guía sobre:</strong>{{ formatGuideTypes(guideInfo.guide.guideTypes) }}</p>
          <p><strong>Comentarios:</strong> {{ guideInfo.guide.amountComments }}</p>
          <p><strong>Puntuación media:</strong> {{ guideInfo.guide.ratingMean === 0 ? 'No puntuada' :
            guideInfo.guide.ratingMean }}</p>
        </div>
        <div class="guide-info">
          <img mat-card-image [src]="guideInfo.guide.thumbnail 
                          ? 'data:image/jpeg;base64,' + guideInfo.guide.thumbnail 
                          : '/assets/images/_11707f36-6180-48c1-b259-16214f3e3e34-logo.jpeg'">
        </div>
      </mat-card-content>
      <mat-divider></mat-divider>
      <mat-card-content>
        <p>
          {{ guideInfo.guide.description }}
        </p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="visualizeGuide(guideInfo.guide.id)">Visualizar guía</button>
        @if(!findGuideIsSaved(guideInfo.guide.id)) {
        <button mat-button color="accent" (click)="addSaved(guideInfo.guide.id)">Añadir a guardados</button>
        }
        @else {
        <button mat-button color="warn" (click)="deleteSaved(guideInfo.guide.id)">Eliminar de guardados</button>
        }
      </mat-card-actions>
    </mat-card>
    }
  </div>
  <div class="options-bottom">
    <button mat-flat-button (click)="resetSearch()" color="warn">Volver al filtro</button>
    <mat-paginator class="mx-2" #paginator [pageSize]="8" [length]="findByFilterResponse.totalGuides"
      aria-label="Select page" [showFirstLastButtons]="true" (page)="handlePageEvent($event)" [pageIndex]="currentPage">
    </mat-paginator>
  </div>
  }
</div>